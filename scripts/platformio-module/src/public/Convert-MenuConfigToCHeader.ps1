

<#
.SYNOPSIS
    Converts an SdkConfig file generated by menuconfig (.config) into an includable C header file
#>
Function Convert-MenuConfigToCHeader {
    [CmdletBinding()]
    Param (
        [Parameter(Mandatory)]
        [ValidateScript({ Test-Path $_ })]
        [string] $InputFile,
        # -----------------------------------
        [Parameter(Mandatory)]
        [ValidateNotNullOrWhiteSpace()]
        [string] $OutputFile
    )

    # The prefix menuconfig uses to prefix config values
    New-Variable -Option Constant VariablePrefix 'CONFIG_'
    # Unique string to prevent duplicate including of the same header file (manual #pragma once)
    New-Variable -Option Constant IncudeGuard "_SDK_CONFIG_f2a1245a4e044039b5dcc1c7d37aa471"

    @"
#ifndef $IncudeGuard
#define $IncudeGuard

"@ | Tee-Object -FilePath $OutputFile
    
    Get-Content $InputFile | ForEach-Object {
        $Line = $_
        # shell comment to C comments
        $Line = $Line -replace '^#', '//'
        # prepend config values with #define
        $Line = $Line -replace "^$VariablePrefix", "#define $VariablePrefix"
        # prepend commented config values as well 
        $Line = $Line -replace "^//( )*$VariablePrefix", "// #define $VariablePrefix"
        # #define doesn't use = so replace the first occurence
        [regex] $pattern = "="
        $Line = $pattern.Replace($Line, ' ', 1);
        
        Write-Output $Line
    } | Tee-Object -Append -FilePath $OutputFile


    @'

#endif
'@ | Tee-Object -Append -FilePath $OutputFile
}